var settings={rules:window.localStorage.rules,excludeRules:window.localStorage.excludeRules,enableAutoMode:window.localStorage.enableAutoMode,enableCookieSync:(function(){if(window.localStorage.enableCookieSync==undefined){return true}else{return window.localStorage.enableCookieSync}}())};var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-46737132-1"]);_gaq.push(["_trackPageview"]);var tabsMode=new Object;var createdTabs=new Object;var isRulesInited=false;function $(a){return document.getElementById(a)}function isChromePrefix(b){if(!b){return false}var a=b.search(/^chrome/i);if(a!=-1){return true}return false}function resetTabMode(a){tabsMode[a]=undefined}function addCreatedTab(a){createdTabs[a]=true}function removeCreatedTab(a){createdTabs[a]=undefined}function isCreatedTab(a){if(createdTabs[a]!=undefined){return true}return false}function update2ProxyUrl(b){var a=getProxyUrl();a+="?ie_url="+escape(b.url);try{chrome.tabs.update(b.id,{url:a,active:true},function(d){updateActionStatus(d,true)})}catch(c){}}function creatProxyUrl(c,a){var b=unescape(c);var d;if(-1==a){d={url:b}}else{d={url:b,index:a}}chrome.tabs.create(d,function(e){if(!matchExcludeRegularRules(b)){updateActionStatus(e,true)}})}function getCrxVersion(b){if(!b){return}var a=chrome.extension.getBackgroundPage();var c=a.location.host;if(c==undefined){return}chrome.management.get(c,function(d){b(d.version)})}function updatePageActionStatus(b,a){var c;if(a){c={tabId:b,path:"icons/ie_48.png"}}else{c={tabId:b,path:"icons/chrome_48.png"}}chrome.pageAction.setIcon(c,function(){chrome.pageAction.show(b)})}function updateActionStatus(b,a){tabsMode[b.id]=a;if(a){updatePageActionStatus(b.id,true)}else{updatePageActionStatus(b.id,false)}}function buildRules(){if(!settings.rules){return}var a=new Array();var g=new Array();var j=unescape(settings.rules);j=j.split("\n");for(var c=0;c<j.length;c++){var f=j[c];if(f.substr(0,2)=="r/"){var b=f.substr(2);if(b){try{a.push(new RegExp(b,"ig"))}catch(d){}}}else{var b=f.replace(/[\^\$\.\+\?\=\!\:\|\\\/\(\)\[\]\{\}]/g,"\\$&").replace("*",".*");try{a.push(new RegExp(b,"ig"))}catch(d){}}}if(a.length!=0){settings.regularRules=a}if(settings.excludeRules){var h=unescape(settings.excludeRules);h=h.split("\n");for(var c=0;c<h.length;c++){var f=h[c];if(f.substr(0,2)=="r/"){var b=f.substr(2);if(b){g.push(new RegExp(b,"ig"))}}else{var b=f.replace(/[\^\$\.\+\?\=\!\:\|\\\/\(\)\[\]\{\}]/g,"\\$&").replace(/\*/g,".$&?");b="^"+b+"$";g.push(new RegExp(b,"ig"))}}}if(g.length!=0){settings.excludeRegularRules=g}isRulesInited=true}function matchRules(d,a){for(var b=0;b<d.length;b++){var c=d[b];if(a.search(c)!=-1){return true}}return false}function menualAddRule(a){if(!a){return}settings.enableAutoMode=true;if(settings.rules){settings.rules+=escape("\n")}else{settings.rules=""}settings.rules+=escape(a);localStorage.setItem("enableAutoMode",true);localStorage.setItem("rules",settings.rules);resetRegularRules()}function resetRegularRules(){isRulesInited=false;settings.excludeRegularRules=null;settings.regularRules=null}function matchRegularRules(a){if(!a){return false}if(!settings.enableAutoMode||!settings.rules){return false}if(!isRulesInited){buildRules()}if(settings.regularRules){if(matchRules(settings.regularRules,a)){return true}}return false}function matchExcludeRegularRules(a){if(!a){return false}if(!settings.enableAutoMode){return false}if(!isRulesInited){buildRules()}if(settings.excludeRegularRules){if(matchRules(settings.excludeRegularRules,a)){return true}}return false}function isAutoModeUrl(a){if(!a){return false}if(matchExcludeRegularRules(a)){return false}if(matchRegularRules(a)){return true}return false}function IsIeModeTab(b){var a=b.id;if(typeof(tabsMode[a])!="undefined"){return tabsMode[a]}if(isAutoModeUrl(b.url)){tabsMode[a]=true}return tabsMode[a]}function getProxyUrl(){return chrome.extension.getURL("proxy.html")}function createNewIeTab(a){chrome.tabs.query({active:true,currentWindow:true},function(c){var b=-1;if(c.length==1){b=c[0].index+1}creatProxyUrl(a,b)})}function switchIeMode(b,a){if(a){_gaq.push(["_trackEvent","open_ie","manual",b.url]);update2ProxyUrl(b)}else{updateActionStatus(b,a);chrome.tabs.update(b.id,{url:b.url})}}function getCookie(a,b){if(a==null||typeof(a)=="undefined"){a=""}if(a.indexOf("chrome://")!=-1){return b("")}chrome.cookies.getAll({url:a},function(f){var g="";for(var c in f){if(g){g=g+"\n"}var d=f[c].name+"="+f[c].value+"; path="+f[c].path+"; domain="+f[c].domain;if((!f[c].session)&&f[c].expirationDate!=undefined){var h=new Date(f[c].expirationDate*1000);d=d+"; expires="+h.toGMTString()}if(f[c].httpOnly){d="#httponly#"+d}if(f[c].secure){d=d+";secure"}g+=d}b(escape(g))})}function isNPFunctionExists(){var a=$("embed");if(!a){return false}if(!a.kOpenInIeCore){return false}return true}function navigate2Welcome(){var a=chrome.extension.getURL("welcome.html");chrome.tabs.create({url:a})}function NPUpate(b){var a="application/ie_your_chrome_plugin" in navigator.mimeTypes;if(a){var d=chrome.extension.getBackgroundPage().document.location.host;var c=d+"\\"+b+"_0";if($("embed").kNotifiyUpdateNP){$("embed").kNotifiyUpdateNP(c)}}}function onClose(b,a){resetTabMode(b);removeCreatedTab(b)}function onCreate(a){addCreatedTab(a.id)}function onUpdate(a,c,b){if(isChromePrefix(b.url)){return}if(isCreatedTab(a)){removeCreatedTab(a);if(IsIeModeTab(b)){update2ProxyUrl(b);return}}updateActionStatus(b,tabsMode[a]);var d=$("embed");if(!d){return}if(!isNPFunctionExists()){return}d.kUpdateUrl(b.id,b.url)}function onReplace(b,a){tabsMode[b]=tabsMode[a];tabsMode[a]=undefined;chrome.tabs.get(b,function(c){if(IsIeModeTab(c)){_gaq.push(["_trackEvent","open_ie","replace",c.url]);update2ProxyUrl(c)}})}chrome.tabs.onRemoved.addListener(onClose);chrome.tabs.onCreated.addListener(onCreate);chrome.tabs.onUpdated.addListener(onUpdate);chrome.tabs.onReplaced.addListener(onReplace);if(chrome.runtime.onInstalled!=undefined){chrome.runtime.onInstalled.addListener(function(a){getCrxVersion(function(c){_gaq.push(["_trackEvent","install_reason",c,a.reason]);var b="application/ie_your_chrome_plugin" in navigator.mimeTypes;if(!b){navigate2Welcome()}})})}chrome.extension.onConnect.addListener(function(a){var b=a.sender.tab;if(isChromePrefix(b.url)){return}if(IsIeModeTab(b)){_gaq.push(["_trackEvent","open_ie","auto",b.url]);update2ProxyUrl(b)}});chrome.pageAction.onClicked.addListener(function(a){if(isChromePrefix(a.url)){return}switchIeMode(a,!tabsMode[a.id])});var contextMenu={init:function(){var b=chrome.contextMenus.create({title:chrome.i18n.getMessage("contextMenu_msg"),contexts:["page","link"],onclick:d});var c=chrome.contextMenus.create({parentId:b,title:chrome.i18n.getMessage("contextMenu_openIe_msg"),contexts:["page","link"],onclick:d});var f=chrome.contextMenus.create({parentId:b,title:chrome.i18n.getMessage("contextMenu_openIe_lnk_msg"),contexts:["link"],onclick:d});var e=chrome.contextMenus.create({parentId:b,title:chrome.i18n.getMessage("contextMenu_addRule_msg"),contexts:["page","link"],onclick:d});var a=chrome.contextMenus.create({parentId:b,title:chrome.i18n.getMessage("contextMenu_addRule_lnk_msg"),contexts:["link"],onclick:d});function d(h,g){switch(h.menuItemId){case c:switchIeMode(g,!tabsMode[g.id]);_gaq.push(["_trackEvent","open_ie","contextmenu",g.url]);break;case f:createNewIeTab(escape(h.linkUrl));_gaq.push(["_trackEvent","open_ie","contextmenu",h.linkUrl]);break;case e:menualAddRule(g.url);_gaq.push(["_trackEvent","add_rule",g.url]);break;case a:menualAddRule(h.linkUrl);_gaq.push(["_trackEvent","add_rule",h.linkUrl]);break;default:break}}}};contextMenu.init();function crx_Inject(b,c,d){var a;if(d==true){a='var c = Math.random().toString().substr(2);                a = document.createElement("script");                a.id = c;                a.type = "text/javascript";                a.innerHTML = "'+c+'"+";document.documentElement.removeChild(document.getElementById(" + c + "));";document.documentElement.appendChild(a);'}else{a=c}chrome.tabs.executeScript(b,{code:a},function(){})}function crx_Navigate(b,a){if(0==a.length){return}chrome.tabs.update(b,{url:a})}(function(){var b=document.createElement("script");b.type="text/javascript";b.async=true;b.src="https://ssl.google-analytics.com/ga.js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(b,a)})();(function(){getCrxVersion(function(b){_gaq.push(["_trackEvent","version",b]);var a="application/ie_your_chrome_plugin" in navigator.mimeTypes;_gaq.push(["_trackEvent","hasnp",a?"1":"0",b]);NPUpate(b)})}());
